;VARIABLES
SEM_V	EQU	P0.0
SEM_R	EQU	P0.1
S_PLAT	EQU	P0.2
F_TIPO	EQU	P0.3
S_FICHA	EQU	P0.4
P_START	EQU	P0.5	;pulsador comienzoi
A_START	EQU	P0.6	;alarma
B_START	EQU	P0.7	;Fin de carrera/posición de reposo del puente de lavado 

B_MOV_F	EQU	P1.0	;Mueve puente lavado hacia alante
B_MOV_B	EQU	P1.1	;Mueve puente hacia atras
FC_RH_T	EQU	P1.2	;Sensor rodillo horizontal en su parte mas alta
RH_UP	EQU	P1.3	;Mover arriba rodillo horiz
RH_DOWN	EQU	P1.4	;Mover abajo rodillo horiz
FC_RV_B	EQU	P1.5	;Fin rodillos verticales exterior
RV_OUT	EQU	P1.6	;Mover hacia fuera rodillos verticales
RH_IN	EQU	P1.7	;Hacia dentro los rodillos verti

EV_AGU	EQU	P2.0	;Activa agua
EV_JBN	EQU	P2.1	;Activa jabon
S_CAR	EQU	P2.3	;Sensor vehiculo sitio lavado
FC_RV_C	EQU	P2.4	;Fin rodillo verticales interior
LED_LN	EQU	P2.5	;Ficha introducida lv normal
LED_LI	EQU	P2.6	;Ficha lavado intenso


;NOS FALTA PWM !!!!!!

SPOS_RH	EQU	P5.0	;sensor distancia, distancia vehiculo rodillo horizontal
SPOS_RV	EQU	P5.1	;sensor distancia, distancia vehiculo rodillo vertical

;---------------------------------------------------
;CODIGO
ORG 00H
LJMP PRINCI

ORG OBH	;Timer 0
LJMP T0

ORG 1BH ;Timer 1
LJMP T1

ORG 007BH
PRINCI: ;COMIENZO PRINCIPAL
	


MAQ_ESTADOS:
	MOV A, ESTADO
 	RL A
	MOV DPTR, #LISTA_EST
 	JMP @A+DPTR

LISTA_EST:
	AJMP EN_ESPERA		; Nombre Estado 0
	AJMP COCHE_PLAT		; Nombre Estado 1
 	AJMP ESP_FICHA		; Nombre Estado 2
 	AJMP ESP_INICIO		; Nombre Estado 3
	AJMP INCIO_LIMPIADO	; Nombre Estado 4
	AJMP EJABONADO		; Nombre Estado 5
	AJMP RODILLO_FROTA	; Nombre Estado 6
	AJMP ENJUAGADO		; Nombre Estado 7
	AJMP VIENTO_SECADO	; Nombre Estado 8
	AJMP FINAL_FELIZ	; Nombre Estado 9

EN_ESPERA:
	ACALL MQ_EVEN_0
 	RET

COCHE_PLAT:
	ACALL MQ_EVEN_1
 	RET

ESP_FICHA:
	ACALL MQ_EVEN_3
 	RET

ESP_INICIO:
	ACALL MQ_EVEN_4
 	RET

INCIO_LIMPIADO:
	ACALL MQ_EVEN_5
 	RET

EJABONADO:
	ACALL MQ_EVEN_6
 	RET

RODILLO_FROTA:
	ACALL MQ_EVEN_6
 	RET

ENJUAGADO:
	ACALL MQ_EVEN_7
 	RET

VIENTO_SECADO:
	ACALL MQ_EVEN_8
 	RET

FINAL_FELIZ:
	ACALL MQ_EVEN_9
 	RET


;-----------------------------------MAQUINAS DE EVENTOS
MQ_EVEN_0: ;==ESTADO 0
	MOV A, EVENTO
	RL A
 	MOV DPTR, #LIST_EVEN_MQEV_0
 	JMP @A+DPTR

LIST_EVEN_MQEV_0: ;LISTA EVENTOS ESTADO 0
	AJMP ME0_EV_0 ; Evento 0
	AJMP ME0_EV_1
	AJMP ME0_EV_2
	AJMP ME0_EV_3
	AJMP ME0_EV_4
	AJMP ME0_EV_5
	AJMP ME0_EV_6
	AJMP ME0_EV_7
	AJMP ME0_EV_8
	AJMP ME0_EV_9
	AJMP ME0_EV_10
	AJMP ME0_EV_11
	AJMP ME0_EV_12
	AJMP ME0_EV_13
	AJMP ME0_EV_14


ME0_EV_0:
 	RET ;SOLO RET SI EL EVENTO0 EN EL ESTADO 0 NO HACE NADA

ME0_EV_1: ;SI EL EVENTO 1 EN EL ESTADO 0 HACE ALGO PONEMOS ACCIONES
	;accion1
	;accion2
	RET

ME0_EV_2:
	RET

ME0_EV_3:
	RET

ME0_EV_4:
	RET

ME0_EV_5:
	RET

ME0_EV_6:
	RET

ME0_EV_7:
	RET

ME0_EV_8:
	RET

ME0_EV_9:
	RET

ME0_EV_10:
	RET

ME0_EV_11:
	RET

ME0_EV_12:
	RET

ME0_EV_13:
	RET

ME0_EV_14:
	RET

;-----------------------------------LO MISMO CON TODOS LOS EVENTOS
; == ESTADO 1 ==
MQ_EVEN_1:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_1
	JMP @A+DPTR

LIST_EVEN_MQEV_1:
	AJMP ME1_EV_0 ; Evento 0
	AJMP ME1_EV_1
	AJMP ME1_EV_2
	AJMP ME1_EV_3
	AJMP ME1_EV_4
	AJMP ME1_EV_5
	AJMP ME1_EV_6
	AJMP ME1_EV_7
	AJMP ME1_EV_8
	AJMP ME1_EV_9
	AJMP ME1_EV_10
	AJMP ME1_EV_11
	AJMP ME1_EV_12
	AJMP ME1_EV_13
	AJMP ME1_EV_14

ME1_EV_0: RET
ME1_EV_1: RET
ME1_EV_2: RET
ME1_EV_3: RET
ME1_EV_4: RET
ME1_EV_5: RET
ME1_EV_6: RET
ME1_EV_7: RET
ME1_EV_8: RET
ME1_EV_9: RET
ME1_EV_10: RET
ME1_EV_11: RET
ME1_EV_12: RET
ME1_EV_13: RET
ME1_EV_14: RET

; == ESTADO 2 ==
MQ_EVEN_2:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_2
	JMP @A+DPTR

LIST_EVEN_MQEV_2:
	AJMP ME2_EV_0 ; Evento 0
	AJMP ME2_EV_1
	AJMP ME2_EV_2
	AJMP ME2_EV_3
	AJMP ME2_EV_4
	AJMP ME2_EV_5
	AJMP ME2_EV_6
	AJMP ME2_EV_7
	AJMP ME2_EV_8
	AJMP ME2_EV_9
	AJMP ME2_EV_10
	AJMP ME2_EV_11
	AJMP ME2_EV_12
	AJMP ME2_EV_13
	AJMP ME2_EV_14

ME2_EV_0: RET
ME2_EV_1: RET
ME2_EV_2: RET
ME2_EV_3: RET
ME2_EV_4: RET
ME2_EV_5: RET
ME2_EV_6: RET
ME2_EV_7: RET
ME2_EV_8: RET
ME2_EV_9: RET
ME2_EV_10: RET
ME2_EV_11: RET
ME2_EV_12: RET
ME2_EV_13: RET
ME2_EV_14: RET

; == ESTADO 3 ==
MQ_EVEN_3:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_3
	JMP @A+DPTR

LIST_EVEN_MQEV_3:
	AJMP ME3_EV_0 ; Evento 0
	AJMP ME3_EV_1
	AJMP ME3_EV_2
	AJMP ME3_EV_3
	AJMP ME3_EV_4
	AJMP ME3_EV_5
	AJMP ME3_EV_6
	AJMP ME3_EV_7
	AJMP ME3_EV_8
	AJMP ME3_EV_9
	AJMP ME3_EV_10
	AJMP ME3_EV_11
	AJMP ME3_EV_12
	AJMP ME3_EV_13
	AJMP ME3_EV_14

ME3_EV_0: RET
ME3_EV_1: RET
ME3_EV_2: RET
ME3_EV_3: RET
ME3_EV_4: RET
ME3_EV_5: RET
ME3_EV_6: RET
ME3_EV_7: RET
ME3_EV_8: RET
ME3_EV_9: RET
ME3_EV_10: RET
ME3_EV_11: RET
ME3_EV_12: RET
ME3_EV_13: RET
ME3_EV_14: RET

; == ESTADO 4 ==
MQ_EVEN_4:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_4
	JMP @A+DPTR

LIST_EVEN_MQEV_4:
	AJMP ME4_EV_0 ; Evento 0
	AJMP ME4_EV_1
	AJMP ME4_EV_2
	AJMP ME4_EV_3
	AJMP ME4_EV_4
	AJMP ME4_EV_5
	AJMP ME4_EV_6
	AJMP ME4_EV_7
	AJMP ME4_EV_8
	AJMP ME4_EV_9
	AJMP ME4_EV_10
	AJMP ME4_EV_11
	AJMP ME4_EV_12
	AJMP ME4_EV_13
	AJMP ME4_EV_14

ME4_EV_0: RET
ME4_EV_1: RET
ME4_EV_2: RET
ME4_EV_3: RET
ME4_EV_4: RET
ME4_EV_5: RET
ME4_EV_6: RET
ME4_EV_7: RET
ME4_EV_8: RET
ME4_EV_9: RET
ME4_EV_10: RET
ME4_EV_11: RET
ME4_EV_12: RET
ME4_EV_13: RET
ME4_EV_14: RET

; == ESTADO 5 ==
MQ_EVEN_5:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_5
	JMP @A+DPTR

LIST_EVEN_MQEV_5:
	AJMP ME5_EV_0 ; Evento 0
	AJMP ME5_EV_1
	AJMP ME5_EV_2
	AJMP ME5_EV_3
	AJMP ME5_EV_4
	AJMP ME5_EV_5
	AJMP ME5_EV_6
	AJMP ME5_EV_7
	AJMP ME5_EV_8
	AJMP ME5_EV_9
	AJMP ME5_EV_10
	AJMP ME5_EV_11
	AJMP ME5_EV_12
	AJMP ME5_EV_13
	AJMP ME5_EV_14

ME5_EV_0: RET
ME5_EV_1: RET
ME5_EV_2: RET
ME5_EV_3: RET
ME5_EV_4: RET
ME5_EV_5: RET
ME5_EV_6: RET
ME5_EV_7: RET
ME5_EV_8: RET
ME5_EV_9: RET
ME5_EV_10: RET
ME5_EV_11: RET
ME5_EV_12: RET
ME5_EV_13: RET
ME5_EV_14: RET

; == ESTADO 6 == faltaannnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnn
MQ_EVEN_6:
	MOV A, EVENTO
	RL A
	MOV DPTR, #LIST_EVEN_MQEV_6
	JMP @A+DPTR

LIST_EVEN_MQEV_6:
	AJMP ME6_EV_0 ; Evento 0
	AJMP ME6_EV_1
	AJMP ME6_EV_2
	AJMP ME6_EV_3
	AJMP

